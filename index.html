<script>
  	const AEMI_URL = 'https://ixymugzdwvblnltxparg.supabase.co';
    const AEMI_KEY = 'sb_publishable_20pACyxu-POCbY0lZcJGvQ_uz9vbJbP';
    const aemi = supabase.createClient(SB_URL, SB_KEY);

    const tagId = new URLSearchParams(window.location.search).get('id');
    document.getElementById('display-id').innerText = tagId || 'ERR';

    async function init() {
        const area = document.getElementById('status-area');
        if(!tagId) { renderError("GEÇERSİZ QR KOD"); return; }

        try {
            // Sorguyu daha güvenli hale getirdik (single yerine normal select)
            const { data, error } = await aemi
                .from('tags')
                .select('*, clients!left(*), tag_data(*)')
                .ilike('tag_id', tagId);
            
            if (error) throw error;

            // Varlık bulunamadıysa
            if (!data || data.length === 0) {
                renderError("VARLIK SİSTEMDE TANIMLI DEĞİL");
                return;
            }

            const tag = data[0];
            const industry = tag.clients?.industry || 'Genel'; //

            // Header ve Logo Ayarı
            document.getElementById('client-header').classList.remove('hidden');
            document.getElementById('client-name').innerText = tag.clients?.client_name || "Bilinmeyen Müşteri";
            if(tag.clients?.logo_url) {
                document.getElementById('client-logo').innerHTML = `<img src="${tag.clients.logo_url}" class="max-h-full object-contain">`;
            }

            // Durum Kontrolü
            if (tag.status === 'IDLE') {
                renderFactoryForm(tag, industry);
            } else if (tag.status === 'FACTORY') {
                renderSiteForm(tag);
            } else {
                renderActiveView(tag.tag_data[0]);
            }

        } catch (e) {
            console.error("Aktivasyon Hatası:", e);
            renderError("BAĞLANTI HATASI: " + e.message);
        }
    }

    // renderFactoryForm, renderSiteForm ve diğer fonksiyonlar aynı kalacak...
    init();
</script>