<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AEMI LABS | Komuta Merkezi</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        #map { height: 400px; border-radius: 1.5rem; border: 1px solid rgba(56, 189, 248, 0.2); }
        .leaflet-container { background: #0f172a; }
    </style>
</head>
<body class="bg-[#0f172a] text-slate-200 min-h-screen p-4 md:p-8">

    <div class="max-w-6xl mx-auto space-y-8">
        <div class="flex justify-between items-end">
            <div>
                <h1 class="text-4xl font-black text-sky-400 tracking-tighter">AEMI MASTER DASHBOARD</h1>
                <p class="text-slate-500 text-xs uppercase tracking-widest">CoÄŸrafi Ä°zleme ve VarlÄ±k YÃ¶netimi</p>
            </div>
            <button onclick="location.reload()" class="bg-sky-600/20 hover:bg-sky-600/40 text-sky-400 px-4 py-2 rounded-lg border border-sky-500/30 text-xs font-bold transition-all">VERÄ°LERÄ° TAZELE</button>
        </div>

        <div class="bg-[#1e293b]/40 backdrop-blur-xl p-4 rounded-[2rem] border border-sky-500/10 shadow-2xl">
            <h2 class="text-sm font-bold text-sky-500 mb-4 px-2 uppercase tracking-widest">CanlÄ± VarlÄ±k HaritasÄ±</h2>
            <div id="map" class="z-0"></div>
        </div>

        <div class="bg-[#1e293b]/40 backdrop-blur-xl rounded-[2rem] border border-slate-700/50 shadow-2xl overflow-hidden">
            <table class="w-full text-left border-collapse">
                <thead class="bg-slate-800/50 text-sky-500 text-[10px] uppercase tracking-[0.2em]">
                    <tr>
                        <th class="p-5">ID / VarlÄ±k</th>
                        <th class="p-5">Durum</th>
                        <th class="p-5">Konum Verisi</th>
                        <th class="p-5 text-right">YÃ¶netim</th>
                    </tr>
                </thead>
                <tbody id="tag-list" class="divide-y divide-slate-800/50">
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        const SB_URL = 'https://ixymugzdwvblnltxparg.supabase.co';
        const SB_KEY = 'sb_publishable_20pACyxu-POCbY0lZcJGvQ_uz9vbJbP';
        const aemiClient = supabase.createClient(SB_URL, SB_KEY);

        let map = L.map('map').setView([39.92, 32.85], 6); // TÃ¼rkiye merkezli baÅŸlat
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        async function loadDashboard() {
    // 1. URL'den hangi mÃ¼ÅŸterinin geldiÄŸini anla
    const urlParams = new URLSearchParams(window.location.search);
    const customerId = urlParams.get('client'); // Ã–rn: ?client=1

    if(!customerId) {
        document.body.innerHTML = "<h1 class='text-center mt-20 text-red-500'>âš ï¸ YETKÄ°SÄ°Z ERÄ°ÅÄ°M: MÃ¼ÅŸteri ID bulunamadÄ±.</h1>";
        return;
    }

    // 2. Sadece bu mÃ¼ÅŸteriye ait etiketleri ve verilerini Ã§ek
    // .eq('client_id', customerId) komutu sihirli dokunuÅŸumuz
    const { data: tags, error } = await aemiClient
        .from('tags')
        .select('*, tag_data(*)')
        .eq('client_id', customerId); 

    if (error) return console.error(error);

    // ... (Geri kalan tablo oluÅŸturma kodlarÄ± aynÄ± kalacak) ...


            const list = document.getElementById('tag-list');
            list.innerHTML = '';
            
            tags.forEach(tag => {
                const attr = tag.tag_data[0]?.attributes || {};
                const gps = attr.gps_location || "";
                
                // Haritaya Pin Ekle (EÄŸer geÃ§erli koordinat varsa)
                if(gps.includes(",")) {
                    const [lat, lng] = gps.split(',').map(Number);
                    L.marker([lat, lng]).addTo(map)
                        .bindPopup(`<b class="text-slate-900">${attr.asset_name || tag.tag_id}</b><br><span class="text-xs text-slate-600">${tag.status}</span>`);
                }

                // Tabloyu Doldur
                list.innerHTML += `
                    <tr class="hover:bg-sky-500/5 transition-all group">
                        <td class="p-5">
                            <div class="font-bold text-sky-400 font-mono">${tag.tag_id}</div>
                            <div class="text-xs text-slate-400">${attr.asset_name || 'TanÄ±msÄ±z'}</div>
                        </td>
                        <td class="p-5">
                            <span class="text-[9px] px-2 py-1 rounded border ${tag.status === 'ACTIVE' ? 'border-green-500/50 text-green-400' : 'border-slate-500 text-slate-500'}">${tag.status}</span>
                        </td>
                        <td class="p-5 text-[10px] font-mono text-slate-500">${gps || '---'}</td>
                        <td class="p-5 text-right space-x-2">
                            <button onclick="editAsset('${tag.tag_id}', '${attr.asset_name || ''}')" class="text-sky-500 hover:bg-sky-500/10 p-2 rounded">âœï¸</button>
                            <button onclick="resetAsset('${tag.tag_id}')" class="text-orange-500 hover:bg-orange-500/10 p-2 rounded" title="SÄ±fÄ±rla">ğŸ”„</button>
                        </td>
                    </tr>
                `;
            });
        }

        async function editAsset(id, oldName) {
            const newName = prompt("Yeni VarlÄ±k AdÄ±:", oldName);
            if (!newName) return;
            // Tag_data'daki attributes'u gÃ¼ncelle
            const { data } = await aemiClient.from('tag_data').select('*').eq('tag_id', id).single();
            const newAttr = { ...data.attributes, asset_name: newName };
            await aemiClient.from('tag_data').update({ attributes: newAttr }).eq('tag_id', id);
            location.reload();
        }

        async function resetAsset(id) {
    const onay = confirm(`${id} etiketini sÄ±fÄ±rlamak istediÄŸine emin misin?\n\nDikkat: VarlÄ±k verileri silinecek ama QR kodunuz Ã§alÄ±ÅŸmaya devam edecektir.`);
    
    if(!onay) return;

    // 1. Tag_data tablosundaki varlÄ±k bilgilerini tamamen sil
    const { error: dataError } = await aemiClient
        .from('tag_data')
                .delete()
        .eq('tag_id', id);

    // 2. Tags tablosundaki durumu tekrar 'IDLE' yap
    const { error: tagError } = await aemiClient
        .from('tags')
        .update({ status: 'IDLE' })
        .eq('tag_id', id);

    if (!dataError && !tagError) {
        alert("Etiket baÅŸarÄ±yla sÄ±fÄ±rlandÄ±. Yeniden tanÄ±mlamaya hazÄ±r!");
        location.reload();
    } else {
        alert("Bir hata oluÅŸtu.");
    }
}
      

        initDashboard();
    </script>
</body>
</html>