<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AEMI LABS | MÃ¼ÅŸteri YÃ¶netim Paneli</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        #map { height: 350px; border-radius: 1.5rem; border: 1px solid rgba(56, 189, 248, 0.2); z-index: 10; }
        .leaflet-container { background: #0f172a; }
        @keyframes pulse-neon {
            0%, 100% { box-shadow: 0 0 15px rgba(14, 165, 233, 0.3); }
            50% { box-shadow: 0 0 25px rgba(14, 165, 233, 0.5); }
        }
        .neon-card { animation: pulse-neon 4s infinite ease-in-out; }
    </style>
</head>
<body class="bg-[#0f172a] text-slate-200 min-h-screen p-4 md:p-8 bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-slate-900 via-[#0f172a] to-black">

    <div id="main-content" class="max-w-6xl mx-auto space-y-8 hidden">
        <div class="flex flex-col md:flex-row justify-between items-center gap-6">
            <div>
                <h1 class="text-4xl font-black text-sky-400 tracking-tighter">AEMI DASHBOARD</h1>
                <p id="client-name" class="text-slate-500 text-xs uppercase tracking-[0.3em] font-bold mt-1">YÃœKLENÄ°YOR...</p>
            </div>
            <div class="flex gap-4">
                <div class="bg-[#1e293b]/50 p-4 rounded-2xl border border-sky-500/20 text-center min-w-[100px]">
                    <p class="text-[9px] text-slate-500 uppercase">Toplam</p>
                    <p id="stat-total" class="text-xl font-bold text-sky-400">0</p>
                </div>
                <div class="bg-[#1e293b]/50 p-4 rounded-2xl border border-green-500/20 text-center min-w-[100px]">
                    <p class="text-[9px] text-slate-500 uppercase">Aktif</p>
                    <p id="stat-active" class="text-xl font-bold text-green-400">0</p>
                </div>
            </div>
        </div>

        <div class="bg-[#1e293b]/40 backdrop-blur-xl p-4 rounded-[2rem] border border-sky-500/10 shadow-2xl neon-card">
            <div id="map"></div>
        </div>

        <div class="bg-[#1e293b]/40 backdrop-blur-xl rounded-[2rem] border border-slate-700/50 shadow-2xl overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-800/50 text-sky-500 text-[10px] uppercase tracking-widest">
                        <tr>
                            <th class="p-5">ID / VarlÄ±k AdÄ±</th>
                            <th class="p-5">Durum</th>
                            <th class="p-5">Son Konum</th>
                            <th class="p-5 text-right">Ä°ÅŸlemler</th>
                        </tr>
                    </thead>
                    <tbody id="tag-list" class="divide-y divide-slate-800/50 text-sm">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="error-screen" class="hidden flex flex-col items-center justify-center min-h-screen text-center p-6">
        <div class="text-6xl mb-4">âš ï¸</div>
        <h1 class="text-2xl font-bold text-red-400 uppercase tracking-tighter">Yetkisiz EriÅŸim</h1>
        <p class="text-slate-500 mt-2 max-w-xs">Bu paneli gÃ¶rÃ¼ntÃ¼lemek iÃ§in geÃ§erli bir mÃ¼ÅŸteri kimliÄŸi gereklidir.</p>
    </div>

    <script>
        // --- AYARLAR ---
        const SB_URL = 'https://ixymugzdwvblnltxparg.supabase.co';
        const SB_KEY = 'sb_publishable_20pACyxu-POCbY0lZcJGvQ_uz9vbJbP';
        const aemiClient = supabase.createClient(SB_URL, SB_KEY);

        const urlParams = new URLSearchParams(window.location.search);
        const customerId = urlParams.get('client'); // URL'den ?client=1 bilgisini alÄ±r

        let map = L.map('map').setView([39.9, 32.8], 6);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        async function start() {
            if (!customerId) {
                document.getElementById('error-screen').classList.remove('hidden');
                return;
            }
            document.getElementById('main-content').classList.remove('hidden');
            loadData();
        }

        async function loadData() {
            // 1. MÃ¼ÅŸteri adÄ±nÄ± Ã§ek
            const { data: clientInfo } = await aemiClient.from('clients').select('name').eq('id', customerId).single();
            if(clientInfo) document.getElementById('client-name').innerText = clientInfo.name + " | VARLIK YÃ–NETÄ°MÄ°";

            // 2. Sadece bu mÃ¼ÅŸteriye ait etiketleri Ã§ek
            const { data: tags, error } = await aemiClient
                .from('tags')
                .select('*, tag_data(*)')
                .eq('client_id', customerId); 

            if (error) return;

            const list = document.getElementById('tag-list');
            list.innerHTML = '';
            let activeCount = 0;

            tags.forEach(tag => {
                const attr = tag.tag_data[0]?.attributes || {};
                const gps = attr.gps_location || "";
                if (tag.status === 'ACTIVE') activeCount++;

                // Haritaya Pin Ekle
                if (gps.includes(",")) {
                    const [lat, lng] = gps.split(',').map(Number);
                    L.marker([lat, lng]).addTo(map).bindPopup(`<b>${attr.asset_name || tag.tag_id}</b>`);
                }

                list.innerHTML += `
                    <tr class="hover:bg-sky-500/5 transition-colors">
                        <td class="p-5 text-sky-400 font-mono font-bold">${tag.tag_id}<br><span class="text-slate-400 font-sans font-normal text-xs">${attr.asset_name || '-'}</span></td>
                        <td class="p-5">
                            <span class="px-2 py-1 rounded text-[9px] font-bold ${tag.status === 'ACTIVE' ? 'bg-green-500/10 text-green-400 border border-green-500/20' : 'bg-slate-700 text-slate-500'} uppercase">${tag.status}</span>
                        </td>
                        <td class="p-5 text-xs text-slate-500 italic">${gps || 'Saha KaydÄ± Yok'}</td>
                        <td class="p-5 text-right space-x-2">
                            <button onclick="editAsset('${tag.tag_id}', '${attr.asset_name || ''}')" class="p-2 hover:bg-sky-500/10 rounded" title="DÃ¼zenle">âœï¸</button>
                            <button onclick="resetAsset('${tag.tag_id}')" class="p-2 hover:bg-orange-500/10 rounded" title="SÄ±fÄ±rla">ğŸ”„</button>
                        </td>
                    </tr>
                `;
            });

            document.getElementById('stat-total').innerText = tags.length;
            document.getElementById('stat-active').innerText = activeCount;
        }

        async function editAsset(id, oldName) {
            const newName = prompt("Yeni VarlÄ±k AdÄ±:", oldName);
            if (!newName) return;
            const { data } = await aemiClient.from('tag_data').select('*').eq('tag_id', id).single();
            const newAttr = { ...data.attributes, asset_name: newName };
            await aemiClient.from('tag_data').update({ attributes: newAttr }).eq('tag_id', id);
            location.reload();
        }

        async function resetAsset(id) {
            if(!confirm("Bu varlÄ±ÄŸÄ± sÄ±fÄ±rlamak istiyor musunuz? Veriler silinecektir.")) return;
            await aemiClient.from('tag_data').delete().eq('tag_id', id);
            await aemiClient.from('tags').update({ status: 'IDLE' }).eq('tag_id', id); // Etiketi boÅŸa Ã§Ä±kar
            location.reload();
        }

        start();
    </script>
</body>
</html>